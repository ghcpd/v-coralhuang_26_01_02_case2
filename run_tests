#!/usr/bin/env python3
"""One-command test runner.

Usage: ./run_tests

- Creates (or reuses) a .venv directory
- Installs pinned dependencies from requirements.txt
- Runs pytest
"""
import os
import platform
import shutil
import subprocess
import sys
from pathlib import Path

ROOT = Path(__file__).parent.resolve()
VENV_DIR = ROOT / ".venv"
REQ = ROOT / "requirements.txt"

PYTHON = sys.executable

def run(cmd, **kwargs):
    print("+ ", " ".join(cmd))
    subprocess.check_call(cmd, **kwargs)


def create_venv():
    if not VENV_DIR.exists():
        run([PYTHON, "-m", "venv", str(VENV_DIR)])


def venv_python() -> str:
    if platform.system() == "Windows":
        return str(VENV_DIR / "Scripts" / "python.exe")
    return str(VENV_DIR / "bin" / "python")


def pip_install():
    py = venv_python()
    run([py, "-m", "pip", "install", "-U", "pip"]) 
    run([py, "-m", "pip", "install", "-r", str(REQ)])
    # Install the local package in editable mode so tests can import `fuzzbench`
    run([py, "-m", "pip", "install", "-e", "."])

def run_pytest():
    py = venv_python()
    run([py, "-m", "pytest", "-q"]) 


def main():
    create_venv()
    pip_install()
    run_pytest()
    print("All tests passed.")

if __name__ == "__main__":
    try:
        main()
    except subprocess.CalledProcessError as e:
        print("Command failed with exit code", e.returncode)
        sys.exit(e.returncode)
